exports.id=863,exports.ids=[863],exports.modules={2243:(a,b,c)=>{"use strict";c.d(b,{iz:()=>u,QN:()=>q,ys:()=>v,N0:()=>w,dv:()=>s,kg:()=>r,ue:()=>t});var d=c(5054);let e=(0,d.GW)(),f={BADAZZ:e,HOOD_HERO:(0,d.GW)(),BOSS_MOVE:(0,d.GW)()},g=[{id:f.BADAZZ,name:"Badazz Tier",description:"Entry membership for everyday OTW runs — groceries, quick pickups, and local errands.",monthlyPriceCents:18e3,includedMiles:2e4,perks:["Standard OTW response time","Access to ERRAND & FOOD services","Access to OTW big hauls at base OTW miles pricing"],allowedServiceTypes:["ERRAND","FOOD","BIG_HAUL"],maxMilesPerRequest:3500},{id:f.HOOD_HERO,name:"Hood Hero Tier",description:"Heavy users: multiple runs per week, big hauls, and household logistics.",monthlyPriceCents:32e3,includedMiles:4e4,perks:["Priority matching over Badazz","Discounted OTW miles for BIG_HAUL","VIP support window"],allowedServiceTypes:["ERRAND","FOOD","BIG_HAUL","VIP"],maxMilesPerRequest:6e3},{id:f.BOSS_MOVE,name:"Boss Move Tier",description:"For businesses, polygamous households, and real movers — concierge-level OTW.",monthlyPriceCents:55e3,includedMiles:8e4,perks:["Top priority matching","Best OTW miles rate for BIG_HAUL & VIP","Dedicated OTW concierge contact (future feature)"],allowedServiceTypes:["ERRAND","FOOD","BIG_HAUL","VIP"],maxMilesPerRequest:1e4}];g.forEach(a=>{a.id===f.BADAZZ&&(a.recommendedUpgradeTierId=f.HOOD_HERO),a.id===f.HOOD_HERO&&(a.recommendedUpgradeTierId=f.BOSS_MOVE)});let h=a=>g.find(b=>b.id===a)||null;var i=c(8803);let j=[],k=a=>j.find(b=>b.customerId===a&&"ACTIVE"===b.status)||null,l=(a,b)=>b<=0||a.milesRemaining>=b,m=a=>{let b=h(a.tierId);return b&&b.recommendedUpgradeTierId&&h(b.recommendedUpgradeTierId)||null};var n=c(9735),o=c(4975);let p=[],q=async a=>{let{distanceKm:b,durationMinutes:c,estimatedMiles:e}=(a=>{let b=a.distanceKmOverride,c=a.durationMinutesOverride;(void 0===b||void 0===c)&&a.pickupLocation&&a.dropoffLocation&&(c=(a=>a<=0?0:Math.round(a/35*60))(b=((a,b)=>{let c=a=>a*Math.PI/180,d=c(b.lat-a.lat),e=c(b.lng-a.lng),f=c(a.lat),g=c(b.lat),h=Math.sin(d/2),i=Math.sin(e/2),j=h*h+Math.cos(f)*Math.cos(g)*i*i,k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j))*6371;return Number.isFinite(k)?k:0})(a.pickupLocation,a.dropoffLocation)));let d=a.estimatedMiles;return(void 0===d||d<=0)&&void 0!==b&&void 0!==c&&(d=(({distanceKm:a,durationMinutes:b,complexityFactor:c=1})=>a<=0||b<=0?0:Math.round((100*a*.7+10*b*.3)*c))({distanceKm:b,durationMinutes:c,complexityFactor:1})),{distanceKm:b,durationMinutes:c,estimatedMiles:d}})(a);if(!e||e<=0)return(0,i._)({message:"Unable to compute OTW miles. Provide estimatedMiles or valid pickup/dropoff locations."});let f=(a=>{let b=k(a);return b?(0,i.ok)(b):(a=>{if(k(a.customerId))return(0,i._)("Customer already has an active membership.");let b=a.tierId&&h(a.tierId)||g[0],c=new Date().toISOString(),d={customerId:a.customerId,tierId:b.id,activeSinceIso:c,renewsAtIso:void 0,milesRemaining:b.includedMiles,status:"ACTIVE"};return j.push(d),(0,i.ok)(d)})({customerId:a})})(a.customerId);if(!f.ok)return(0,i._)({message:"Unable to ensure membership.",details:f.error});let n=f.data,o=h(n.tierId);if(!o)return(0,i._)({message:"Tier not found for membership."});let q=((a,b,c)=>{if(c<=0)return(0,i.ok)({eligible:!0,reason:"No OTW miles needed.",suggestedUpgradeTier:null});if(b.maxMilesPerRequest&&c>b.maxMilesPerRequest){let d=m(a);return(0,i._)({eligible:!1,reason:`This request requires ${c} OTW miles, which exceeds your tier's per-request cap of ${b.maxMilesPerRequest}.`,suggestedUpgradeTier:d||null})}if(!l(a,c)){let b=m(a);return(0,i._)({eligible:!1,reason:"You do not have enough OTW miles to cover this request.",suggestedUpgradeTier:b||null})}return(0,i.ok)({eligible:!0,reason:"Membership can cover this request.",suggestedUpgradeTier:null})})(n,o,e);if(!q.ok)return(0,i._)({message:"Request not eligible for current membership.",info:q.error});let r=q.data,s=((a,b)=>b<=0?(0,i.ok)(a):l(a,b)?(a.milesRemaining-=b,a.milesRemaining<0&&(a.milesRemaining=0),(0,i.ok)(a)):(0,i._)("Insufficient OTW miles for this request."))(n,e);if(!s.ok)return(0,i._)({message:"Failed to deduct OTW miles for this request.",details:s.error});let t=new Date().toISOString(),u={id:(0,d.H4)(),customerId:a.customerId,serviceType:a.serviceType,status:"PENDING",createdAt:t,updatedAt:t,assignedDriverId:void 0,acceptedAtIso:void 0,completedAtIso:void 0,pickupLocation:a.pickupLocation,dropoffLocation:a.dropoffLocation,estimatedDistanceKm:b,estimatedDurationMinutes:c,estimatedMiles:e,chargedMiles:void 0,notes:a.notes};return p.push(u),(0,i.ok)({request:u,membership:n,tier:o,eligibility:r})},r=a=>p.filter(b=>b.customerId===a).sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime()),s=()=>p.filter(a=>"PENDING"===a.status||"MATCHED"===a.status&&!a.assignedDriverId),t=a=>p.filter(b=>b.assignedDriverId===a).sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime()),u=(a,b)=>{let c=p.find(b=>b.id===a);return c?c.assignedDriverId&&c.assignedDriverId!==b?(0,i._)("Request is already assigned to another driver."):(c.assignedDriverId=b,c.status="MATCHED",c.updatedAt=new Date().toISOString(),(0,i.ok)(c)):(0,i._)("Request not found.")},v=(a,b)=>{let c=p.find(b=>b.id===a);return c?c.assignedDriverId&&c.assignedDriverId!==b?(0,i._)("Request is assigned to a different driver."):(c.assignedDriverId=b,c.status="ACCEPTED",c.acceptedAtIso=new Date().toISOString(),c.updatedAt=new Date().toISOString(),(0,i.ok)(c)):(0,i._)("Request not found.")},w=(a,b)=>{let c=p.find(b=>b.id===a);if(!c)return(0,i._)("Request not found.");if(c.assignedDriverId!==b)return(0,i._)("Request is not assigned to this driver.");c.status="COMPLETED",c.completedAtIso=new Date().toISOString(),c.chargedMiles=c.estimatedMiles,c.updatedAt=new Date().toISOString(),(0,n.Cv)(b);let d=(0,o.Um)(c);return d.errors&&d.errors.length>0&&console.warn("NIP reward issues for request",c.id,d.errors),(0,i.ok)(c)}},4975:(a,b,c)=>{"use strict";c.d(b,{KA:()=>m,Nd:()=>l,Um:()=>o,ku:()=>n,ls:()=>k});var d=c(5054),e=c(8803);let f=[],g=[],h=a=>f.find(b=>b.ownerCustomerId===a)||null,i=a=>f.find(b=>b.ownerDriverId===a)||null,j=a=>{let b;if(!a.ownerCustomerId&&!a.ownerDriverId)return(0,e._)("NIP ledger entry must have an owner.");b=a.ownerCustomerId?(a=>{let b=h(a);if(b)return b;let c={ownerCustomerId:a,ownerDriverId:void 0,balance:0,totalEarned:0};return f.push(c),c})(a.ownerCustomerId):(a=>{let b=i(a);if(b)return b;let c={ownerCustomerId:void 0,ownerDriverId:a,balance:0,totalEarned:0};return f.push(c),c})(a.ownerDriverId);let c={id:(0,d.Jg)(),createdAt:new Date().toISOString(),ownerCustomerId:a.ownerCustomerId,ownerDriverId:a.ownerDriverId,delta:a.delta,reason:a.reason,meta:a.meta||{}};return b.balance+=a.delta,a.delta>0&&(b.totalEarned+=a.delta),g.push(c),(0,e.ok)(b)},k=a=>h(a),l=a=>i(a),m=a=>g.filter(b=>b.ownerCustomerId===a).sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime()),n=a=>g.filter(b=>b.ownerDriverId===a).sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime()),o=a=>{let b=[],c=(a=>{let b=Math.round((a.estimatedMiles||0)/100),c=b<=0?1:b,d=Math.round(.4*c),e=Math.round(.6*c);return{customerReward:d<=0?1:d,driverReward:e<=0?1:e,baseNip:c}})(a),d=null,f=null;if(a.customerId){let f=((a,b,c,d)=>b<=0?(0,e._)("NIP credit must be positive."):j({ownerCustomerId:a,delta:b,reason:c,meta:d}))(a.customerId,c.customerReward,"COMPLETED_REQUEST",{requestId:a.id});f.ok?d=f.data:b.push(`Failed to credit customer NIP: ${String(f.error)}`)}if(a.assignedDriverId){let d=((a,b,c,d)=>b<=0?(0,e._)("NIP credit must be positive."):j({ownerDriverId:a,delta:b,reason:c,meta:d}))(a.assignedDriverId,c.driverReward,"COMPLETED_REQUEST",{requestId:a.id});d.ok?f=d.data:b.push(`Failed to credit driver NIP: ${String(d.error)}`)}return{rewards:c,customerWallet:d,driverWallet:f,errors:b.length?b:void 0}}},5054:(a,b,c)=>{"use strict";function d(){return`tier_${Math.random().toString(36).slice(2,10)}`}function e(){return`req_${Math.random().toString(36).slice(2,10)}`}function f(){return`drv_${Math.random().toString(36).slice(2,10)}`}function g(){return`led_${Math.random().toString(36).slice(2,10)}`}c.d(b,{GW:()=>d,H4:()=>e,Jg:()=>g,ME:()=>f})},6487:()=>{},8335:()=>{},8803:(a,b,c)=>{"use strict";function d(a){return{ok:!0,data:a}}function e(a){return{ok:!1,error:a}}c.d(b,{_:()=>e,ok:()=>d})},9735:(a,b,c)=>{"use strict";c.d(b,{Cv:()=>h,ur:()=>g});var d=c(5054),e=c(8803);let f=[],g=a=>{if(!a.displayName.trim())return(0,e._)("Driver displayName is required.");let b=(0,d.ME)(),c=new Date().toISOString(),g={driverId:b,displayName:a.displayName.trim(),baseZone:a.baseZone||"GENERAL",tier:"BRONZE",status:"OFFLINE",completedJobs:0,cancelledJobs:0,avgRating:0,lastActiveAt:c,franchiseScore:0,franchiseRank:"NOT_ELIGIBLE",franchiseEligible:!1,franchiseLastEvaluatedAt:c};return f.push(g),(0,e.ok)(g)},h=a=>{let b=f.find(b=>b.driverId===a);return b?(b.completedJobs+=1,b.lastActiveAt=new Date().toISOString(),(0,e.ok)(b)):(0,e._)("Driver not found.")}}};